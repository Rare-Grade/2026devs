<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Attendance Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Custom Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-card { animation: fadeIn 0.5s ease-out forwards; }
        .glass-panel { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body class="bg-slate-900 text-gray-100 font-sans antialiased min-h-screen p-6">

    <header class="flex justify-between items-center mb-8 animate-card">
        <div>
            <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">
                Attendance Command Center
            </h1>
            <p class="text-gray-400 mt-1" id="currentDateDisplay">Live Monitoring System</p>
        </div>
        <div class="flex gap-4">
            <div class="glass-panel px-6 py-2 rounded-lg text-center">
                <span class="block text-2xl font-bold text-blue-400" id="totalCount">0</span>
                <span class="text-xs text-gray-400 uppercase tracking-wide">Present</span>
            </div>
            <div class="glass-panel px-6 py-2 rounded-lg text-center">
                <span class="block text-2xl font-bold text-green-400" id="activeCount">0</span>
                <span class="text-xs text-gray-400 uppercase tracking-wide">Active</span>
            </div>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <div class="lg:col-span-1 space-y-6">
            <div class="glass-panel p-6 rounded-2xl animate-card" style="animation-delay: 0.1s;">
                <h3 class="text-lg font-semibold mb-4 text-gray-300">Current Status</h3>
                <div class="relative h-64">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>

            <div class="glass-panel p-6 rounded-2xl animate-card" style="animation-delay: 0.2s;">
                <h3 class="text-lg font-semibold mb-4 text-gray-300">Live Activity Feed</h3>
                <div id="activityFeed" class="space-y-3 h-64 overflow-y-auto pr-2 scrollbar-thin scrollbar-thumb-gray-700">
                    <div class="text-center text-gray-500 text-sm italic mt-10">Waiting for scans...</div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-2">
            <div class="glass-panel p-6 rounded-2xl h-full animate-card" style="animation-delay: 0.3s;">
                <h3 class="text-lg font-semibold mb-6 text-gray-300 flex justify-between items-center">
                    Employee Overview
                    <span class="text-xs bg-blue-500/20 text-blue-300 px-2 py-1 rounded">Live Sync</span>
                </h3>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="text-gray-400 text-sm border-b border-gray-700">
                                <th class="pb-3 pl-2">Employee ID</th>
                                <th class="pb-3">Time In</th>
                                <th class="pb-3">Lunch Status</th>
                                <th class="pb-3">Time Out</th>
                                <th class="pb-3">Current State</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTableBody" class="text-sm">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // --- PASTE THE SAME FIREBASE CONFIG HERE ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
            projectId: "YOUR_PROJECT",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef"
        };
        // -------------------------------------------

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('currentDateDisplay').innerText = new Date().toDateString();

        // Chart Setup
        const ctx = document.getElementById('statusChart').getContext('2d');
        const statusChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Working', 'On Lunch', 'Clocked Out'],
                datasets: [{
                    data: [0, 0, 0],
                    backgroundColor: ['#3b82f6', '#eab308', '#ef4444'],
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { color: '#9ca3af' } } }
            }
        });

        // Realtime Listener
        db.ref(`attendance/${today}`).on('value', (snapshot) => {
            const data = snapshot.val();
            updateDashboard(data);
        });

        function updateDashboard(data) {
            const tableBody = document.getElementById('attendanceTableBody');
            const feed = document.getElementById('activityFeed');
            
            if (!data) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No records today</td></tr>';
                return;
            }

            tableBody.innerHTML = ''; // Clear table
            
            let working = 0, onLunch = 0, finished = 0;
            let total = 0;
            
            // Convert object to array and sort by last update (roughly)
            const employees = Object.values(data);
            
            employees.forEach(emp => {
                total++;
                
                // Determine Status Logic
                let statusBadge = '';
                if (emp.lastAction === 'Time Out') {
                    finished++;
                    statusBadge = '<span class="px-2 py-1 rounded bg-red-500/20 text-red-400 text-xs">Left</span>';
                } else if (emp.lastAction === 'Lunch Out') {
                    onLunch++;
                    statusBadge = '<span class="px-2 py-1 rounded bg-yellow-500/20 text-yellow-400 text-xs">Lunch</span>';
                } else {
                    working++;
                    statusBadge = '<span class="px-2 py-1 rounded bg-green-500/20 text-green-400 text-xs">Working</span>';
                }

                // Populate Table
                const row = `
                    <tr class="border-b border-gray-800 hover:bg-white/5 transition">
                        <td class="py-4 pl-2 font-mono text-blue-300">${emp.id}</td>
                        <td class="py-4 text-gray-400">${emp.TimeIn || '--'}</td>
                        <td class="py-4 text-gray-400">
                            ${emp.LunchOut ? `<span class="text-yellow-500">${emp.LunchOut}</span>` : '--'} 
                            ${emp.LunchBack ? `âžœ <span class="text-green-500">${emp.LunchBack}</span>` : ''}
                        </td>
                        <td class="py-4 text-gray-400">${emp.TimeOut || '--'}</td>
                        <td class="py-4">${statusBadge}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            // Update Header Stats
            document.getElementById('totalCount').innerText = total;
            document.getElementById('activeCount').innerText = working;

            // Update Chart
            statusChart.data.datasets[0].data = [working, onLunch, finished];
            statusChart.update();
            
            // Update Feed (Just showing the last few actions visually)
            // In a real app, you'd sort by timestamp. Here we just grab the raw list.
            feed.innerHTML = '';
            employees.reverse().slice(0, 5).forEach(emp => {
                let color = 'text-blue-400';
                if(emp.lastAction.includes('Out')) color = 'text-red-400';
                if(emp.lastAction.includes('Lunch')) color = 'text-yellow-400';
                
                feed.innerHTML += `
                    <div class="flex justify-between items-center text-sm border-l-2 border-gray-700 pl-3 py-1">
                        <div>
                            <span class="font-bold text-gray-200">${emp.id}</span>
                            <span class="text-gray-500 text-xs ml-2">${emp.lastUpdate}</span>
                        </div>
                        <span class="${color}">${emp.lastAction}</span>
                    </div>
                `;
            });
        }
    </script>
</body>
</html>
