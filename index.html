<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Command Center | Enterprise Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #f3f4f6; }
        
        /* Glassmorphic Pill Header */
        .glass-header {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 9999px;
            margin: 1.5rem 2rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .glass-card { 
            background: white; 
            border-radius: 1.5rem; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .glass-card:hover { transform: translateY(-6px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .modal { transition: opacity 0.25s ease; z-index: 100; }
        body.modal-active { overflow-x: hidden; overflow-y: visible !important; }
        .pill-btn { border-radius: 9999px; transition: all 0.3s ease; transform: scale(1); }
        .pill-btn:hover { transform: translateY(-1px); filter: brightness(110%); }
        .pill-btn:active { transform: scale(0.96); }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 10px; }
        .action-menu { display: none; position: absolute; background: white; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border: 1px solid #f3f4f6; z-index: 50; width: 160px; }
        .action-item:hover { background: #eff6ff; color: #2563eb; }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden">

    <header class="z-20">
        <nav class="glass-header px-8 py-3 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <img src="https://i.postimg.cc/05BVVkbb/LOGO-removebg-preview.png" alt="Logo" class="h-9 w-auto">
                <div>
                    <h1 class="text-lg font-black tracking-tight leading-none">
                        <span class="text-white">ATTENDANCE</span><span class="text-blue-500">HUB</span>
                    </h1>
                    <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">Enterprise Analytics</p>
                </div>
            </div>
            
            <div class="flex gap-3">
                <button onclick="startScanner()" class="pill-btn bg-purple-600 text-white px-5 py-2 text-[11px] font-black flex items-center gap-2 shadow-lg shadow-purple-500/20">
                    
                </button>
                <button onclick="generateGlobalReport()" class="pill-btn bg-white/5 text-white border border-white/10 hover:bg-white/20 px-5 py-2 text-[11px] font-black flex items-center gap-2">
                    <i class="fa-solid fa-file-export"></i> EXPORT
                </button>
                <button onclick="toggleModal('addEmployeeModal')" class="pill-btn bg-blue-600 text-white px-5 py-2 text-[11px] font-black flex items-center gap-2 shadow-lg shadow-blue-500/20">
                    <i class="fa-solid fa-plus"></i> ADD STAFF
                </button>
            </div>
        </nav>
    </header>

    <main class="flex-1 flex overflow-hidden">
        <aside class="w-1/3 bg-gray-50/50 p-6 pt-2 overflow-y-auto border-r border-gray-200 flex flex-col gap-6 custom-scroll">
            <div class="grid grid-cols-2 gap-4">
                <div class="glass-card p-5 border-b-4 border-blue-500">
                    <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Total Staff</p>
                    <h2 class="text-3xl font-black text-gray-800" id="totalEmployees">0</h2>
                </div>
                <div class="glass-card p-5 border-b-4 border-green-500">
                    <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Active Now</p>
                    <h2 class="text-3xl font-black text-gray-800" id="presentToday">0</h2>
                </div>
            </div>

            <div class="glass-card p-6">
                <h3 class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-4">Live Distribution</h3>
                <canvas id="attendanceChart" height="240"></canvas>
            </div>

            <div class="glass-card flex-1 flex flex-col min-h-[400px]">
                <div class="p-5 border-b border-gray-50 flex justify-between items-center">
                    <h3 class="font-black text-gray-700 text-sm uppercase tracking-wider">Employee Directory</h3>
                    <span class="bg-blue-100 text-blue-600 text-[10px] font-black px-3 py-1 rounded-full" id="regCount">0</span>
                </div>
                <div class="overflow-y-auto p-3 custom-scroll" id="employeeList">
                    <div class="text-center text-gray-300 py-10 font-medium">Loading Database...</div>
                </div>
            </div>
        </aside>

        <section class="flex-1 bg-gray-100/50 p-8 pt-2 overflow-y-auto custom-scroll">
            <div class="glass-card min-h-full p-8">
                <div class="flex justify-between items-end mb-10">
                    <div>
                        <span class="bg-blue-600 text-white text-[10px] font-black px-3 py-1 rounded-lg">LIVE LOG</span>
                        <h2 class="text-3xl font-black text-gray-900 mt-2">Attendance Feed</h2>
                        <p id="dateDisplay" class="text-sm font-bold text-gray-400 mt-1"></p>
                    </div>
                    <div class="flex gap-2 bg-white p-2 rounded-2xl shadow-inner border border-gray-100">
                        <div class="flex items-center gap-2 px-4 py-2 rounded-xl bg-blue-50 text-blue-600 text-[10px] font-black">
                            <div class="w-2 h-2 rounded-full bg-blue-500 animate-ping"></div> WORKING
                        </div>
                        <div class="flex items-center gap-2 px-4 py-2 rounded-xl bg-yellow-50 text-yellow-600 text-[10px] font-black">
                            <div class="w-2 h-2 rounded-full bg-yellow-400"></div> LUNCH
                        </div>
                        <div class="flex items-center gap-2 px-4 py-2 rounded-xl bg-red-50 text-red-600 text-[10px] font-black">
                            <div class="w-2 h-2 rounded-full bg-red-500"></div> FINISHED
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto relative">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="text-[10px] font-black text-gray-400 uppercase tracking-widest border-b border-gray-100">
                                <th class="pb-4 px-4">Staff Member</th>
                                <th class="pb-4 px-4">Clock In</th>
                                <th class="pb-4 px-4">Lunch Break</th>
                                <th class="pb-4 px-4 text-center">Compliance</th>
                                <th class="pb-4 px-4">Clock Out</th>
                                <th class="pb-4 px-4 text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTable" class="divide-y divide-gray-50 text-sm">
                            <tr><td colspan="6" class="py-20 text-center text-gray-300">Awaiting stream...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <div id="scannerModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[80]">
        <div class="modal-overlay absolute w-full h-full bg-gray-900/90 backdrop-blur-md"></div>
        <div class="modal-container bg-white w-full max-w-lg mx-auto rounded-[2rem] shadow-2xl z-50 overflow-hidden relative">
            <div class="p-6 bg-gray-50 border-b border-gray-100 flex justify-between items-center">
                <h3 class="font-black text-gray-800 text-lg">Scan Attendance QR</h3>
                <button onclick="stopScanner()" class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-gray-600"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-4 bg-black">
                <div id="reader" class="w-full h-64 bg-black"></div>
            </div>
            <div class="p-6 text-center">
                <p class="text-sm text-gray-500 font-bold mb-2">Point scanner at employee QR code</p>
                <div id="scanStatus" class="text-xs font-mono text-blue-500">Ready to scan...</div>
            </div>
        </div>
    </div>

    <div id="statsModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900/60 backdrop-blur-md"></div>
        <div class="modal-container bg-white w-full max-w-4xl mx-auto rounded-[2rem] shadow-2xl z-50 overflow-hidden">
            <div id="statsContent" class="p-10">
                <div class="flex justify-between items-center mb-10">
                    <div class="flex gap-6 items-center">
                        <div id="statAvatar" class="w-20 h-20 rounded-3xl bg-blue-600 text-white flex items-center justify-center text-4xl font-black shadow-2xl shadow-blue-200"></div>
                        <div>
                            <h2 id="statName" class="text-4xl font-black text-gray-900">Name</h2>
                            <p id="statIdRole" class="text-blue-600 font-black uppercase tracking-widest text-xs mt-1"></p>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="downloadPersonalPDF()" class="pill-btn bg-blue-50 text-blue-600 px-6 py-3 text-xs font-black">
                            <i class="fa-solid fa-download mr-2"></i> EXPORT PDF
                        </button>
                        <button onclick="toggleModal('statsModal')" class="pill-btn bg-gray-100 text-gray-500 px-6 py-3 text-xs font-black">CLOSE</button>
                    </div>
                </div>
                <div class="grid grid-cols-4 gap-4 mb-10">
                    <div class="bg-gray-50 p-6 rounded-3xl border border-gray-100">
                        <p class="text-[10px] font-black text-gray-400 uppercase mb-1">Total Hours</p>
                        <p class="text-3xl font-black text-gray-900" id="statTotalHours">0.0</p>
                    </div>
                    <div class="bg-gray-50 p-6 rounded-3xl border border-gray-100">
                        <p class="text-[10px] font-black text-gray-400 uppercase mb-1">Avg Clock-In</p>
                        <p class="text-3xl font-black text-gray-900" id="statAvgClockIn">--:--</p>
                    </div>
                    <div class="bg-gray-50 p-6 rounded-3xl border border-gray-100">
                        <p class="text-[10px] font-black text-gray-400 uppercase mb-1">Punctuality Score</p>
                        <p class="text-3xl font-black text-gray-900" id="statPunctuality">0%</p>
                    </div>
                    <div class="bg-gray-50 p-6 rounded-3xl border border-gray-100">
                        <p class="text-[10px] font-black text-gray-400 uppercase mb-1">Lunch Compliance</p>
                        <p class="text-3xl font-black text-blue-600" id="statBreakComp">0%</p>
                    </div>
                </div>
                <div class="h-64 rounded-3xl bg-gray-50/50 p-6 border border-gray-100">
                    <canvas id="personalTrendChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div id="addEmployeeModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900/40 backdrop-blur-sm"></div>
        <div class="modal-container bg-white w-full max-w-md mx-auto rounded-[2.5rem] shadow-2xl z-50">
            <div class="p-10">
                <div class="text-center mb-8">
                    <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-2xl flex items-center justify-center mx-auto text-2xl mb-4">
                        <i class="fa-solid fa-user-plus"></i>
                    </div>
                    <h2 class="text-2xl font-black text-gray-900">New Registration</h2>
                    <p class="text-gray-400 text-sm font-bold">Automatic ID generation enabled.</p>
                </div>
                <form id="addEmployeeForm" class="space-y-5">
                    <div>
                        <label class="block text-[10px] font-black text-gray-400 uppercase ml-2 mb-2">Full Legal Name</label>
                        <input type="text" id="newEmpName" required placeholder="e.g. John Doe" class="w-full rounded-2xl border-gray-100 bg-gray-50 px-6 py-4 text-sm focus:ring-4 focus:ring-blue-500/10 outline-none border transition-all">
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-gray-400 uppercase ml-2 mb-2">Job Title / Department</label>
                        <input type="text" id="newEmpRole" required placeholder="e.g. Senior Analyst" class="w-full rounded-2xl border-gray-100 bg-gray-50 px-6 py-4 text-sm focus:ring-4 focus:ring-blue-500/10 outline-none border transition-all">
                    </div>
                    <div class="pt-6 flex gap-3">
                        <button type="button" onclick="toggleModal('addEmployeeModal')" class="flex-1 pill-btn bg-gray-100 text-gray-500 font-black py-4">CANCEL</button>
                        <button type="submit" class="flex-1 pill-btn bg-blue-600 text-white font-black py-4 shadow-xl shadow-blue-500/20">SAVE STAFF</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="confirmDeleteModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[70]">
        <div class="modal-overlay absolute w-full h-full bg-gray-900/60 backdrop-blur-md"></div>
        <div class="modal-container bg-white w-full max-w-xs mx-auto rounded-[2.5rem] shadow-2xl z-50 overflow-hidden">
            <div class="p-8 text-center">
                <div class="w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4 text-xl">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                </div>
                <h3 class="text-xl font-black text-gray-900">Are you sure?</h3>
                <p class="text-gray-500 text-xs mt-2 leading-relaxed">This will remove <span id="deleteTargetName" class="font-bold text-gray-800"></span> from the registry. This action is irreversible.</p>
                <div class="flex flex-col gap-2 mt-8">
                    <button id="finalDeleteBtn" class="pill-btn bg-red-600 text-white font-black py-3 text-sm">DELETE PERMANENTLY</button>
                    <button onclick="toggleModal('confirmDeleteModal')" class="pill-btn bg-gray-100 text-gray-500 font-black py-3 text-sm">CANCEL</button>
                </div>
            </div>
        </div>
    </div>

    <div id="successModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[60]">
        <div class="modal-overlay absolute w-full h-full bg-gray-900/60 backdrop-blur-sm"></div>
        <div class="modal-container bg-white w-full max-w-sm mx-auto rounded-[2rem] shadow-2xl z-50 p-8 text-center">
            <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                <i class="fa-solid fa-check"></i>
            </div>
            <h3 class="text-xl font-black text-gray-900">Success!</h3>
            <p class="text-gray-500 text-sm mt-2 mb-4">Employee added. Save this QR code.</p>
            
            <div class="flex justify-center mb-6">
                <div id="qrCodeContainer" class="p-3 bg-white border border-gray-100 rounded-xl shadow-lg"></div>
            </div>

            <div class="flex flex-col gap-2">
                <a id="downloadQrBtn" href="#" class="w-full pill-btn bg-blue-600 text-white font-black py-3 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-download"></i> DOWNLOAD QR
                </a>
                <button onclick="toggleModal('successModal')" class="w-full pill-btn bg-gray-900 text-white font-black py-3">DONE</button>
            </div>
        </div>
    </div>

    <div id="adminActionMenu" class="action-menu py-2 overflow-hidden">
        <div onclick="adminSetAction('Clock In')" class="action-item px-4 py-2 text-xs font-black cursor-pointer border-b border-gray-50">CLOCK IN</div>
        <div onclick="adminSetAction('Lunch Out')" class="action-item px-4 py-2 text-xs font-black cursor-pointer">LUNCH OUT</div>
        <div onclick="adminSetAction('Lunch Back')" class="action-item px-4 py-2 text-xs font-black cursor-pointer border-b border-gray-50">LUNCH BACK</div>
        <div onclick="adminSetAction('Clock Out')" class="action-item px-4 py-2 text-xs font-black cursor-pointer text-red-500">CLOCK OUT</div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAxBT0oESoL62oz_x_Z8cMtdENWZPx4tMI",
            authDomain: "pinotp-d7ef5.firebaseapp.com",
            databaseURL: "https://pinotp-d7ef5-default-rtdb.firebaseio.com",
            projectId: "pinotp-d7ef5",
            storageBucket: "pinotp-d7ef5.firebasestorage.app",
            messagingSenderId: "708458917827",
            appId: "1:708458917827:web:375de278577df0adcf9776"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const todayStr = new Date().toISOString().split('T')[0];
        document.getElementById('dateDisplay').innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        const LATE_THRESHOLD = "09:00";
        let personalChart = null;
        let selectedEmpId = null;
        let pendingDeleteId = null;
        let activeAdminId = null;
        let html5QrCode = null; // Scanner instance

        const gCtx = document.getElementById('attendanceChart').getContext('2d');
        const globalChart = new Chart(gCtx, {
            type: 'doughnut',
            data: {
                labels: ['Working', 'Lunch', 'Clocked Out'],
                datasets: [{
                    data: [0, 0, 0],
                    backgroundColor: ['#2563eb', '#fbbf24', '#ef4444'],
                    hoverOffset: 15,
                    borderWidth: 0,
                    borderRadius: 8
                }]
            },
            options: { cutout: '80%', plugins: { legend: { display: true, position: 'bottom', labels: { usePointStyle: true, font: { weight: 'bold', size: 10 } } } } }
        });

        db.ref('employees').on('value', snap => {
            const list = document.getElementById('employeeList');
            const data = snap.val();
            list.innerHTML = '';
            if(!data) return;
            document.getElementById('totalEmployees').innerText = Object.keys(data).length;
            document.getElementById('regCount').innerText = Object.keys(data).length;
            Object.values(data).forEach(emp => {
                const row = document.createElement('div');
                row.className = "flex items-center gap-4 p-4 hover:bg-white hover:shadow-xl hover:shadow-gray-200/50 rounded-2xl cursor-pointer transition-all group mb-1";
                row.innerHTML = `
                    <div onclick="fetchEmployeeHistory('${emp.id}', '${emp.name}', '${emp.role}')" class="w-12 h-12 rounded-xl bg-gray-50 flex items-center justify-center font-black text-blue-600 group-hover:bg-blue-600 group-hover:text-white transition-all shadow-inner">
                        ${emp.name.charAt(0)}
                    </div>
                    <div onclick="fetchEmployeeHistory('${emp.id}', '${emp.name}', '${emp.role}')" class="flex-1">
                        <p class="text-sm font-black text-gray-800">${emp.name}</p>
                        <p class="text-[9px] font-black text-gray-400 uppercase tracking-tighter">${emp.role}</p>
                    </div>
                    <button onclick="promptDelete('${emp.id}', '${emp.name}')" class="opacity-0 group-hover:opacity-100 p-2 text-red-400 hover:text-red-600 transition-all">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                `;
                list.appendChild(row);
            });
        });

        db.ref('attendance/' + todayStr).on('value', snap => {
            const data = snap.val();
            const tbody = document.getElementById('attendanceTable');
            tbody.innerHTML = '';
            let stats = { working: 0, lunch: 0, out: 0, total: 0 };
            if(data) {
                Object.values(data).forEach(log => {
                    stats.total++;
                    let statusLabel = 'OFFLINE', statusCol = 'bg-gray-50 text-gray-400', pulse = '';
                    let complianceHtml = '<span class="text-gray-200">-</span>';
                    let clockInHtml = log.TimeIn || '--:--';
                    if(log.TimeIn && log.TimeIn > LATE_THRESHOLD) {
                        clockInHtml = `<span class="text-red-600 font-black">${log.TimeIn}</span> <span class="bg-red-50 text-red-500 text-[8px] px-1 rounded">LATE</span>`;
                    }
                    if(log.LunchOut && log.LunchBack) {
                        const dur = calculateDuration(log.LunchOut, log.LunchBack) * 60;
                        complianceHtml = dur > 60 ? `<span class="text-red-600 font-black">OVER (${Math.round(dur)}m)</span>` : `<span class="text-green-600 font-black">PASS</span>`;
                    }
                    if(log.lastAction?.includes('In') || log.lastAction === 'Lunch Back') {
                        stats.working++; statusLabel = 'WORKING'; statusCol = 'bg-blue-50 text-blue-600'; pulse = 'animate-pulse';
                    } else if (log.lastAction === 'Lunch Out') {
                        stats.lunch++; statusLabel = 'LUNCH'; statusCol = 'bg-yellow-50 text-yellow-700';
                    } else {
                        stats.out++; statusLabel = 'FINISHED'; statusCol = 'bg-red-50 text-red-700';
                    }
                    tbody.innerHTML += `
                        <tr class="group hover:bg-gray-50/50 transition-colors">
                            <td class="p-4 font-black text-gray-800 flex items-center gap-3">
                                <div>${log.name || 'User'} <br><span class="text-[10px] text-gray-300 font-bold">${log.id}</span></div>
                                <button onclick="showAdminActions(event, '${log.id}')" class="p-1.5 bg-blue-50 text-blue-500 rounded-lg hover:bg-blue-500 hover:text-white transition-all">
                                    <i class="fa-solid fa-clock-rotate-left text-[10px]"></i>
                                </button>
                            </td>
                            <td class="p-4 font-mono font-bold text-gray-500">${clockInHtml}</td>
                            <td class="p-4 text-[11px] font-bold">
                                ${log.LunchOut ? `<span class="text-red-400">OUT: ${log.LunchOut}</span>` : ''}
                                ${log.LunchBack ? `<br><span class="text-green-500">BACK: ${log.LunchBack}</span>` : ''}
                            </td>
                            <td class="p-4 text-center text-xs">${complianceHtml}</td>
                            <td class="p-4 font-mono font-bold text-gray-500">${log.TimeOut || '--:--'}</td>
                            <td class="p-4 text-center">
                                <span class="${statusCol} ${pulse} px-4 py-2 rounded-xl text-[10px] font-black border border-current opacity-80">${statusLabel}</span>
                            </td>
                        </tr>`;
                });
            }
            document.getElementById('presentToday').innerText = stats.total;
            globalChart.data.datasets[0].data = [stats.working, stats.lunch, stats.out];
            globalChart.update();
        });

        // --- SCANNER LOGIC START ---

        function startScanner() {
            toggleModal('scannerModal');
            html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
            .catch(err => {
                document.getElementById('scanStatus').innerText = "Camera access denied or error.";
                console.error(err);
            });
        }

        function stopScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    toggleModal('scannerModal');
                }).catch(err => console.log(err));
            } else {
                toggleModal('scannerModal');
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            // Stop scanning temporarily to process
            html5QrCode.pause(); 
            document.getElementById('scanStatus').innerText = `Processing: ${decodedText}...`;

            // Validate ID exists in DB
            db.ref('employees/' + decodedText).once('value').then(snap => {
                if(snap.exists()) {
                    const empData = snap.val();
                    processScanLogic(decodedText, empData.name);
                } else {
                    alert("Invalid QR Code: Employee not found.");
                    html5QrCode.resume();
                }
            });
        }

        function processScanLogic(id, name) {
            const path = `attendance/${todayStr}/${id}`;
            const now = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
            
            db.ref(path).once('value').then(snap => {
                const data = snap.val() || {};
                let update = { id: id, name: name };
                let actionTaken = "";

                // Logic Flow: 1st Scan (In) -> 2nd (Lunch Out) -> 3rd (Lunch Back) -> 4th (Out)
                if (!data.TimeIn) {
                    update.TimeIn = now;
                    update.lastAction = "Clock In";
                    actionTaken = "CLOCKED IN";
                } else if (data.TimeIn && !data.LunchOut) {
                    update.LunchOut = now;
                    update.lastAction = "Lunch Out";
                    actionTaken = "LUNCH OUT";
                } else if (data.LunchOut && !data.LunchBack) {
                    update.LunchBack = now;
                    update.lastAction = "Lunch Back";
                    actionTaken = "LUNCH BACK";
                } else if (data.LunchBack && !data.TimeOut) {
                    update.TimeOut = now;
                    update.lastAction = "Clock Out";
                    actionTaken = "CLOCKED OUT";
                } else {
                    alert(`${name} has already completed all actions for today.`);
                    html5QrCode.resume();
                    document.getElementById('scanStatus').innerText = "Ready to scan...";
                    return;
                }

                db.ref(path).update(update).then(() => {
                    alert(`${actionTaken}: ${name}`);
                    // Resume scanning for next person
                    html5QrCode.resume();
                    document.getElementById('scanStatus').innerText = "Ready to scan...";
                });
            });
        }

        // --- SCANNER LOGIC END ---

        function showAdminActions(e, id) {
            e.stopPropagation();
            activeAdminId = id;
            const menu = document.getElementById('adminActionMenu');
            menu.style.display = 'block';
            menu.style.left = (e.pageX - 10) + 'px';
            menu.style.top = (e.pageY + 10) + 'px';
        }

        window.onclick = () => document.getElementById('adminActionMenu').style.display = 'none';

        function adminSetAction(action) {
            if(!activeAdminId) return;
            const now = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
            const path = `attendance/${todayStr}/${activeAdminId}`;
            let update = { lastAction: action };
            
            if(action === 'Clock In') update.TimeIn = now;
            else if(action === 'Lunch Out') update.LunchOut = now;
            else if(action === 'Lunch Back') update.LunchBack = now;
            else if(action === 'Clock Out') update.TimeOut = now;

            db.ref(path).update(update);
        }

        function promptDelete(id, name) {
            pendingDeleteId = id;
            document.getElementById('deleteTargetName').innerText = name;
            toggleModal('confirmDeleteModal');
        }

        document.getElementById('finalDeleteBtn').onclick = () => {
            if(pendingDeleteId) {
                db.ref('employees/' + pendingDeleteId).remove().then(() => {
                    toggleModal('confirmDeleteModal');
                    pendingDeleteId = null;
                });
            }
        };

        async function fetchEmployeeHistory(id, name, role) {
            selectedEmpId = id;
            document.getElementById('statName').innerText = name;
            document.getElementById('statIdRole').innerText = `${id} â€¢ ${role}`;
            document.getElementById('statAvatar').innerText = name.charAt(0);
            const historySnap = await db.ref('attendance').once('value');
            const allDays = historySnap.val() || {};
            let totalHours = 0, daysWorked = 0, chartLabels = [], chartData = [], totalBreaks = 0, okBreaks = 0, punctDays = 0;
            for(let i=6; i>=0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const dStr = d.toISOString().split('T')[0];
                chartLabels.push(d.toLocaleDateString('en-US', { weekday: 'short' }));
                if(allDays[dStr] && allDays[dStr][id]) {
                    const log = allDays[dStr][id]; daysWorked++;
                    const duration = calculateDuration(log.TimeIn, log.TimeOut);
                    totalHours += duration; chartData.push(duration);
                    if(log.TimeIn && log.TimeIn <= LATE_THRESHOLD) punctDays++;
                    if(log.LunchOut && log.LunchBack) { totalBreaks++; if(calculateDuration(log.LunchOut, log.LunchBack) * 60 <= 60) okBreaks++; }
                } else { chartData.push(0); }
            }
            document.getElementById('statTotalHours').innerText = totalHours.toFixed(1);
            document.getElementById('statPunctuality').innerText = daysWorked ? Math.round((punctDays/daysWorked)*100) + '%' : '100%';
            document.getElementById('statBreakComp').innerText = totalBreaks ? Math.round((okBreaks/totalBreaks)*100) + '%' : '100%';
            toggleModal('statsModal'); renderPersonalChart(chartLabels, chartData);
        }

        function calculateDuration(inT, outT) {
            if(!inT || !outT || outT === '--:--') return 0;
            const parse = (s) => { const [h, m] = s.split(':').map(Number); return h + (m/60); };
            return Math.abs(parse(outT) - parse(inT));
        }

        function renderPersonalChart(labels, data) {
            if(personalChart) personalChart.destroy();
            personalChart = new Chart(document.getElementById('personalTrendChart').getContext('2d'), {
                type: 'bar', data: { labels: labels, datasets: [{ label: 'Hours', data: data, backgroundColor: '#2563eb', borderRadius: 8 }] },
                options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        async function downloadPersonalPDF() {
            const canvas = await html2canvas(document.getElementById('statsContent'), { scale: 2 });
            const doc = new jspdf.jsPDF('p', 'mm', 'a4');
            doc.text(`Performance Report: ${document.getElementById('statName').innerText}`, 15, 15);
            doc.addImage(canvas.toDataURL('image/png'), 'PNG', 10, 25, 190, 110);
            doc.save(`Report_${selectedEmpId}.pdf`);
        }

        async function generateGlobalReport() {
            const doc = new jspdf.jsPDF();
            doc.setFontSize(22); doc.text("Global Operations Report", 20, 25);
            doc.text(`Active Employees: ${document.getElementById('totalEmployees').innerText}`, 20, 45);
            doc.save("Global_Report.pdf");
        }

        document.getElementById('addEmployeeForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = `EMP-${Math.random().toString(16).slice(2, 6).toUpperCase()}`;
            const name = document.getElementById('newEmpName').value.trim();
            const role = document.getElementById('newEmpRole').value.trim();

            db.ref('employees/' + id).set({
                id, name, role,
                createdAt: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                toggleModal('addEmployeeModal');
                document.getElementById('addEmployeeForm').reset();
                
                // GENERATE QR
                const qrContainer = document.getElementById('qrCodeContainer');
                qrContainer.innerHTML = ''; // Clear previous
                new QRCode(qrContainer, {
                    text: id,
                    width: 150,
                    height: 150
                });

                // Set download link with slight delay to allow canvas render
                setTimeout(() => {
                    const qrCanvas = qrContainer.querySelector('canvas');
                    if(qrCanvas) {
                        const dlBtn = document.getElementById('downloadQrBtn');
                        dlBtn.href = qrCanvas.toDataURL("image/png");
                        dlBtn.download = `QR_${name.replace(' ', '_')}.png`;
                    }
                    toggleModal('successModal');
                }, 300);
            });
        });

        function toggleModal(id) {
            const m = document.getElementById(id);
            m.classList.toggle('opacity-0');
            m.classList.toggle('pointer-events-none');
            document.body.classList.toggle('modal-active');
        }
    </script>
</body>
</html>
