<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bophelo Bot | Facility Finder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />

    <style>
        :root { --medical-emerald: #10b981; }
        body { font-family: 'Inter', sans-serif; overflow: hidden; background-color: #e2e8f0; }
        #map { position: absolute; inset: 0; z-index: 0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .slide-in-left { animation: slideInLeft 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideInLeft { from { transform: translateX(-100%); } to { transform: translateX(0); } }
    </style>
</head>
<body class="h-screen w-screen relative">

    <div id="map"></div>

    <div class="absolute top-4 right-4 md:right-8 z-20 flex items-center gap-3">
        <div class="bg-white/90 backdrop-blur-md px-4 py-2 rounded-full shadow-lg border border-slate-100 hidden md:block">
            <span id="location-status" class="text-[10px] font-bold text-emerald-600 tracking-wide uppercase">GPS Linked</span>
        </div>
        <button onclick="handleSignOut()" class="w-12 h-12 rounded-full bg-white shadow-lg border border-slate-200 overflow-hidden hover:scale-105 transition active:scale-95 flex items-center justify-center">
            <img id="user-avatar" src="" alt="Profile" class="w-full h-full object-cover hidden">
            <i id="guest-icon" class="fa-solid fa-user text-slate-400 text-lg"></i>
        </button>
    </div>

    <div class="absolute z-30 bg-white w-full bottom-0 rounded-t-[30px] shadow-2xl md:top-0 md:left-0 md:w-[420px] md:h-full md:rounded-none flex flex-col overflow-hidden max-h-[85vh] md:max-h-full slide-up md:slide-in-left">

        <div id="login-view" class="p-8 flex flex-col h-full justify-center">
            <div class="mb-8 text-center md:text-left">
                <div class="w-12 h-12 bg-emerald-100 rounded-xl flex items-center justify-center text-emerald-600 mb-4 mx-auto md:mx-0">
                    <i class="fa-solid fa-location-crosshairs text-xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-900 mb-2">Bophelo Bot</h2>
                <p class="text-slate-500 text-sm">Real-time facility routing and medical assistance.</p>
            </div>
            <div class="space-y-3">
                <button onclick="handleSignIn('google')" class="w-full flex items-center justify-center gap-3 bg-white border border-slate-200 text-slate-700 p-4 rounded-2xl font-semibold hover:bg-slate-50 transition">
                    <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5"> Sign in with Google
                </button>
            </div>
        </div>

        <div id="app-view" class="flex flex-col h-full hidden">
            <div class="px-6 pt-8 pb-4 border-b border-slate-100">
                <div class="relative">
                    <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <input id="facility-search" type="text" placeholder="Search (e.g. Pharmacy, ER)" 
                        class="w-full bg-slate-50 p-4 pl-12 rounded-2xl outline-none focus:ring-2 focus:ring-emerald-500/20 font-medium transition-all"
                        onkeypress="if(event.key === 'Enter') searchAndRoute(this.value)">
                </div>
            </div>

            <div class="flex-1 overflow-y-auto no-scrollbar p-6 space-y-4 bg-slate-50/50">
                <div id="route-info" class="hidden bg-emerald-600 text-white p-5 rounded-3xl shadow-lg mb-4">
                    <h4 class="text-xs font-bold uppercase opacity-80 mb-1">Active Destination</h4>
                    <p id="dest-name" class="font-bold text-lg leading-tight">Finding route...</p>
                    <div class="flex gap-4 mt-3 text-sm font-medium">
                        <span><i class="fa-solid fa-car mr-1"></i> <span id="route-dist">0 km</span></span>
                        <span><i class="fa-solid fa-clock mr-1"></i> <span id="route-time">0 min</span></span>
                    </div>
                </div>

                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Recommended</h3>
                
                <div onclick="searchAndRoute('Hospital')" class="bg-white p-4 rounded-3xl border border-slate-100 cursor-pointer hover:border-emerald-500 transition">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-red-50 text-red-500 rounded-xl flex items-center justify-center"><i class="fa-solid fa-truck-medical"></i></div>
                        <div><h4 class="font-bold">Nearest Emergency ER</h4><p class="text-xs text-slate-500">Auto-route to highest rated</p></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1Ijoia2F0bGVnb3BoYXNoYSIsImEiOiJjbTlpOTdzbmYwMGNsMmpzYWJtZzN4d3pqIn0.Zt-aSMEoahrV3zkiVVHbOw';
        
        const firebaseConfig = {
            apiKey: "AIzaSyAxBT0oESoL62oz_x_Z8cMtdENWZPx4tMI",
            authDomain: "pinotp-d7ef5.firebaseapp.com",
            databaseURL: "https://pinotp-d7ef5-default-rtdb.firebaseio.com",
            projectId: "pinotp-d7ef5",
            storageBucket: "pinotp-d7ef5.firebasestorage.app",
            messagingSenderId: "708458917827",
            appId: "1:708458917827:web:375de278577df0adcf9776"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        let map, userCoords = [28.2293, -25.7479]; 

        function initMap() {
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/navigation-day-v1',
                center: userCoords,
                zoom: 14
            });
            updateUserLocation();
        }

        function updateUserLocation() {
            navigator.geolocation.getCurrentPosition(pos => {
                userCoords = [pos.coords.longitude, pos.coords.latitude];
                map.setCenter(userCoords);
                new mapboxgl.Marker({ color: '#10b981' }).setLngLat(userCoords).addTo(map);
            });
        }

        async function searchAndRoute(query) {
            const searchUrl = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?proximity=${userCoords[0]},${userCoords[1]}&access_token=${mapboxgl.accessToken}`;
            const res = await fetch(searchUrl);
            const data = await res.json();
            
            if (data.features.length > 0) {
                const target = data.features[0];
                const destCoords = target.center;
                document.getElementById('dest-name').innerText = target.text;
                document.getElementById('route-info').classList.remove('hidden');
                getRoute(destCoords, target.text);
            }
        }

        async function getRoute(end, name) {
            const query = await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${userCoords[0]},${userCoords[1]};${end[0]},${end[1]}?steps=true&geometries=geojson&access_token=${mapboxgl.accessToken}`);
            const json = await query.json();
            const data = json.routes[0];
            
            document.getElementById('route-dist').innerText = (data.distance / 1000).toFixed(1) + ' km';
            document.getElementById('route-time').innerText = Math.floor(data.duration / 60) + ' min';

            const geojson = { type: 'Feature', geometry: data.geometry };
            if (map.getSource('route')) { map.getSource('route').setData(geojson); }
            else {
                map.addLayer({ id: 'route', type: 'line', source: { type: 'geojson', data: geojson }, paint: { 'line-color': '#10b981', 'line-width': 6, 'line-opacity': 0.8 }});
            }
            
            map.fitBounds([userCoords, end], { padding: 80 });

            if (auth.currentUser) {
                database.ref('users/' + auth.currentUser.uid + '/active_route').set({
                    destination: name,
                    eta_mins: Math.floor(data.duration / 60),
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('app-view').classList.remove('hidden');
                document.getElementById('user-avatar').src = user.photoURL;
                document.getElementById('user-avatar').classList.remove('hidden');
                document.getElementById('guest-icon').classList.add('hidden');
            } else {
                document.getElementById('login-view').classList.remove('hidden');
                document.getElementById('app-view').classList.add('hidden');
            }
        });

        function handleSignIn(p) { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
        function handleSignOut() { auth.signOut(); }

        initMap();
    </script>
</body>
</html>
