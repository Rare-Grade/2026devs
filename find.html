<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bophelo Bot | Facility Finder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        :root { --medical-emerald: #10b981; }
        body { font-family: 'Inter', sans-serif; overflow: hidden; background-color: #e2e8f0; }
        #map { position: absolute; inset: 0; z-index: 0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .slide-in-left { animation: slideInLeft 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideInLeft { from { transform: translateX(-100%); } to { transform: translateX(0); } }
    </style>
</head>
<body class="h-screen w-screen relative">
    <div id="map"></div>
    <div class="absolute top-4 right-4 md:right-8 z-20 flex items-center gap-3">
        <div class="bg-white/90 backdrop-blur-md px-4 py-2 rounded-full shadow-lg border border-slate-100 hidden md:block">
            <span id="location-status" class="text-[10px] font-bold text-emerald-600 tracking-wide uppercase">GPS Linked</span>
        </div>
        <button onclick="handleSignOut()" class="w-12 h-12 rounded-full bg-white shadow-lg border border-slate-200 overflow-hidden hover:scale-105 transition active:scale-95 flex items-center justify-center">
            <img id="user-avatar" src="" alt="Profile" class="w-full h-full object-cover hidden">
            <i id="guest-icon" class="fa-solid fa-user text-slate-400 text-lg"></i>
        </button>
    </div>
    <div class="absolute z-30 bg-white w-full bottom-0 rounded-t-[30px] shadow-2xl md:top-0 md:left-0 md:w-[420px] md:h-full md:rounded-none flex flex-col overflow-hidden max-h-[85vh] md:max-h-full slide-up md:slide-in-left">
        <div id="login-view" class="p-8 flex flex-col h-full justify-center">
            <div class="mb-8 text-center md:text-left">
                <div class="w-12 h-12 bg-emerald-100 rounded-xl flex items-center justify-center text-emerald-600 mb-4 mx-auto md:mx-0">
                    <i class="fa-solid fa-location-crosshairs text-xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-900 mb-2">Bophelo Bot</h2>
                <p class="text-slate-500 text-sm">Real-time facility routing and medical assistance.</p>
            </div>
            <div class="space-y-3">
                <button onclick="handleSignIn('google')" class="w-full flex items-center justify-center gap-3 bg-white border border-slate-200 text-slate-700 p-4 rounded-2xl font-semibold hover:bg-slate-50 transition">
                    <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5"> Sign in with Google
                </button>
                <button onclick="handleSignIn('github')" class="w-full flex items-center justify-center gap-3 bg-white border border-slate-200 text-slate-700 p-4 rounded-2xl font-semibold hover:bg-slate-50 transition">
                    <img src="https://www.svgrepo.com/show/452229/github.svg" class="w-5 h-5"> Sign in with GitHub
                </button>
            </div>
            <div class="relative my-6">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-slate-200"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="bg-white px-4 text-slate-400">or</span>
                </div>
            </div>
            <div class="space-y-4">
                <input id="email-input" type="email" placeholder="Enter your email" required class="w-full bg-slate-50 p-4 rounded-2xl outline-none focus:ring-2 focus:ring-emerald-500/20 font-medium transition-all">
                <input id="password-input" type="password" placeholder="Enter your password" required class="w-full bg-slate-50 p-4 rounded-2xl outline-none focus:ring-2 focus:ring-emerald-500/20 font-medium transition-all">
                <button onclick="handleEmailSignIn()" class="w-full bg-emerald-600 text-white p-4 rounded-2xl font-semibold hover:bg-emerald-700 transition">
                    Continue with Email
                </button>
            </div>
            <p class="text-xs text-slate-500 text-center mt-4">New here? We'll create an account for you.</p>
        </div>
        <div id="app-view" class="flex flex-col h-full hidden">
            <div class="px-6 pt-8 pb-4 border-b border-slate-100">
                <div class="relative">
                    <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <input id="facility-search" type="text" placeholder="Search (e.g. Pharmacy, ER)"
                        class="w-full bg-slate-50 p-4 pl-12 rounded-2xl outline-none focus:ring-2 focus:ring-emerald-500/20 font-medium transition-all"
                        onkeypress="if(event.key === 'Enter') searchAndRoute(this.value)">
                </div>
            </div>
            <div class="flex-1 overflow-y-auto no-scrollbar p-6 space-y-4 bg-slate-50/50">
                <div id="route-info" class="hidden bg-emerald-600 text-white p-5 rounded-3xl shadow-lg mb-4">
                    <h4 class="text-xs font-bold uppercase opacity-80 mb-1">Active Destination</h4>
                    <p id="dest-name" class="font-bold text-lg leading-tight">Finding route...</p>
                    <div class="flex gap-4 mt-3 text-sm font-medium">
                        <span><i id="mode-icon" class="fa-solid fa-car mr-1"></i> <span id="route-dist">0 km</span></span>
                        <span><i class="fa-solid fa-clock mr-1"></i> <span id="route-time">0 min</span></span>
                    </div>
                    <div class="flex justify-center gap-4 mt-5">
                        <button data-mode="driving" onclick="setMode('driving')" class="mode-btn p-3 rounded-xl bg-white/40 hover:bg-white/50 transition text-2xl"><i class="fa-solid fa-car"></i></button>
                        <button data-mode="driving-traffic" onclick="setMode('driving-traffic')" class="mode-btn p-3 rounded-xl bg-white/20 hover:bg-white/30 transition text-2xl"><i class="fa-solid fa-bus"></i></button>
                        <button data-mode="cycling" onclick="setMode('cycling')" class="mode-btn p-3 rounded-xl bg-white/20 hover:bg-white/30 transition text-2xl"><i class="fa-solid fa-bicycle"></i></button>
                        <button data-mode="walking" onclick="setMode('walking')" class="mode-btn p-3 rounded-xl bg-white/20 hover:bg-white/30 transition text-2xl"><i class="fa-solid fa-person-walking"></i></button>
                        <button onclick="startVoiceNavigation()" class="p-3 rounded-xl bg-white/20 hover:bg-white/30 transition text-2xl"><i class="fa-solid fa-volume-high"></i></button>
                    </div>
                </div>
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Recommended</h3>
                <div onclick="searchAndRoute('Hospital')" class="bg-white p-4 rounded-3xl border border-slate-100 cursor-pointer hover:border-emerald-500 transition">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-red-50 text-red-500 rounded-xl flex items-center justify-center"><i class="fa-solid fa-truck-medical"></i></div>
                        <div><h4 class="font-bold">Nearest Emergency ER</h4><p class="text-xs text-slate-500">Auto-route to highest rated</p></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script>
        mapboxgl.accessToken = 'pk.eyJ1Ijoia2F0bGVnb3BoYXNoYSIsImEiOiJjbTlpOTdzbmYwMGNsMmpzYWJtZzN4d3pqIn0.Zt-aSMEoahrV3zkiVVHbOw';
      
        const firebaseConfig = {
            apiKey: "AIzaSyAxBT0oESoL62oz_x_Z8cMtdENWZPx4tMI",
            authDomain: "pinotp-d7ef5.firebaseapp.com",
            databaseURL: "https://pinotp-d7ef5-default-rtdb.firebaseio.com",
            projectId: "pinotp-d7ef5",
            storageBucket: "pinotp-d7ef5.firebasestorage.app",
            messagingSenderId: "708458917827",
            appId: "1:708458917827:web:375de278577df0adcf9776"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        let map, userCoords = [28.2293, -25.7479];
        let currentMode = 'driving';
        let currentDestCoords = null;
        let currentDestName = null;
        let destMarker = null;
        let turnMarkers = [];
        let currentInstructions = [];
        let watchId = null;

        function initMap() {
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/navigation-night-v1',
                center: userCoords,
                zoom: 14
            });

            map.on('load', () => {
                // Real-time traffic overlay
                map.addSource('mapbox-traffic', {
                    type: 'vector',
                    url: 'mapbox://mapbox.mapbox-traffic-v1'
                });

                map.addLayer({
                    id: 'traffic',
                    type: 'line',
                    source: 'mapbox-traffic',
                    'source-layer': 'traffic',
                    layout: { 'line-join': 'round', 'line-cap': 'round' },
                    paint: {
                        'line-width': 4,
                        'line-color': [
                            'match',
                            ['get', 'congestion'],
                            'low', '#00b300',
                            'moderate', '#ffaa00',
                            'heavy', '#ff6600',
                            'severe', '#ff0000',
                            '#aaaaaa'
                        ]
                    }
                }, 'road-label');

                // Weather radar overlay
                const updateWeatherOverlay = async () => {
                    try {
                        const resp = await fetch('https://api.rainviewer.com/public/weather-maps.json');
                        const data = await resp.json();
                        let ts = data.generated;
                        if (data.radar.past && data.radar.past.length > 0) {
                            ts = data.radar.past[data.radar.past.length - 1].time;
                        }
                        const tileUrl = `${data.host}/v2/radar/${ts}/256/{z}/{x}/{y}/2/1_1.png`;

                        if (map.getSource('radar')) {
                            map.getSource('radar').setTiles([tileUrl]);
                        } else {
                            map.addSource('radar', {
                                type: 'raster',
                                tiles: [tileUrl],
                                tileSize: 256,
                                attribution: '© RainViewer'
                            });
                            map.addLayer({
                                id: 'radar-layer',
                                type: 'raster',
                                source: 'radar',
                                paint: { 'raster-opacity': 0.45 }
                            });
                        }
                    } catch (err) {
                        console.error('Weather overlay update failed:', err);
                    }
                };

                updateWeatherOverlay();
                setInterval(updateWeatherOverlay, 600000);
            });

            startLocationTracking();
        }

        function createUserMarker(coords) {
            const markerEl = document.createElement('div');
            markerEl.innerHTML = `
                <div class="relative">
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-12 h-12 bg-emerald-400 rounded-full opacity-75 animate-ping"></div>
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-12 h-12 bg-emerald-400 rounded-full opacity-40"></div>
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-10 h-10 bg-emerald-600 rounded-full shadow-2xl flex items-center justify-center">
                        <i class="fa-solid fa-person text-white text-2xl"></i>
                    </div>
                </div>
            `;
            window.userMarker = new mapboxgl.Marker({
                element: markerEl,
                anchor: 'center'
            }).setLngLat(coords).addTo(map);
        }

        function startLocationTracking() {
            if ('geolocation' in navigator) {
                if (watchId !== null) {
                    navigator.geolocation.clearWatch(watchId);
                }
                watchId = navigator.geolocation.watchPosition(
                    (pos) => {
                        const newCoords = [pos.coords.longitude, pos.coords.latitude];
                        userCoords = newCoords;

                        if (window.userMarker) {
                            window.userMarker.setLngLat(newCoords);
                        } else {
                            createUserMarker(newCoords);
                        }

                        // Center on user only when no active route
                        if (!currentDestCoords) {
                            map.setCenter(newCoords);
                        }
                    },
                    (err) => console.error('Geolocation error:', err),
                    { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 }
                );
            }
        }

        async function searchAndRoute(query) {
            const searchUrl = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?proximity=${userCoords[0]},${userCoords[1]}&access_token=${mapboxgl.accessToken}`;
            const res = await fetch(searchUrl);
            const data = await res.json();
          
            if (data.features.length > 0) {
                const target = data.features[0];
                const destCoords = target.center;
                currentDestCoords = destCoords;
                currentDestName = target.text;

                // Clear previous destination marker
                if (destMarker) destMarker.remove();

                // Destination marker with full details popup on click
                const destEl = document.createElement('div');
                destEl.innerHTML = `
                    <div class="relative">
                        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-12 h-12 bg-red-400 rounded-full opacity-75 animate-ping"></div>
                        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-12 h-12 bg-red-400 rounded-full opacity-40"></div>
                        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-10 h-10 bg-red-600 rounded-full shadow-2xl flex items-center justify-center">
                            <i class="fa-solid fa-location-dot text-white text-3xl"></i>
                        </div>
                    </div>
                `;
                destMarker = new mapboxgl.Marker({
                    element: destEl,
                    anchor: 'center'
                }).setLngLat(destCoords).addTo(map);

                destMarker.setPopup(new mapboxgl.Popup({
                    offset: 25,
                    closeButton: true,
                    closeOnClick: false
                }).setHTML(`
                    <div class="bg-white p-4 rounded-lg shadow-lg max-w-xs font-medium">
                        <strong class="text-lg block mb-1">${target.text}</strong>
                        <span class="text-sm text-slate-600">${target.place_name || 'No address available'}</span>
                    </div>
                `));

                destMarker.getElement().addEventListener('click', () => destMarker.togglePopup());

                document.getElementById('dest-name').innerText = target.text;
                document.getElementById('route-info').classList.remove('hidden');
                setActiveModeButtons();
                updateModeIcon();
                getRoute(destCoords, target.text, target.place_name);
            }
        }

        async function getRoute(end, name, fullName) {
            // Clear previous route and markers
            if (map.getLayer('route')) map.removeLayer('route');
            if (map.getSource('route')) map.removeSource('route');
            turnMarkers.forEach(m => m.remove());
            turnMarkers = [];
            currentInstructions = [];

            const profile = currentMode;
            const query = await fetch(`https://api.mapbox.com/directions/v5/mapbox/${profile}/${userCoords[0]},${userCoords[1]};${end[0]},${end[1]}?steps=true&geometries=geojson&access_token=${mapboxgl.accessToken}`);
            const json = await query.json();
            if (!json.routes || json.routes.length === 0) return;
            const data = json.routes[0];
          
            document.getElementById('route-dist').innerText = (data.distance / 1000).toFixed(1) + ' km';
            document.getElementById('route-time').innerText = Math.floor(data.duration / 60) + ' min';
            updateModeIcon();

            const geojson = { type: 'Feature', geometry: data.geometry };
            map.addSource('route', { type: 'geojson', data: geojson });
            map.addLayer({ 
                id: 'route', 
                type: 'line', 
                source: 'route', 
                paint: { 'line-color': '#ffffff', 'line-width': 10, 'line-opacity': 0.8 }
            });

            // Starting instruction
            currentInstructions = [`Starting navigation to ${name}. Distance ${(data.distance / 1000).toFixed(1)} km, estimated time ${Math.floor(data.duration / 60)} minutes.`];

            // Turn-by-turn markers with detailed popups on click
            data.legs[0].steps.forEach((step, index) => {
                if (step.maneuver && step.maneuver.location) {
                    const coords = step.maneuver.location.coordinates;
                    const instruction = step.maneuver.instruction || 'Continue straight';
                    const stepDist = step.distance ? (step.distance / 1000).toFixed(1) + ' km' : 'short distance';
                    const stepTime = step.duration ? '~' + Math.round(step.duration / 60) + ' min' : '';

                    currentInstructions.push(instruction);

                    const el = document.createElement('div');
                    el.className = 'bg-white text-emerald-600 w-9 h-9 rounded-full flex items-center justify-center font-bold text-sm shadow-lg border-2 border-emerald-600 cursor-pointer';
                    el.innerText = index + 1;

                    const popup = new mapboxgl.Popup({
                        offset: 35,
                        closeButton: true,
                        closeOnClick: false
                    }).setHTML(`
                        <div  class="bg-white p-4 rounded-lg shadow-lg max-w-xs">
                            <strong class="block mb-1">Step ${index + 1}</strong>
                            <p class="font-medium">${instruction}</p>
                            ${stepDist || stepTime ? `<p class="text-sm text-slate-600 mt-2">${stepDist} • ${stepTime}</p>` : ''}
                        </div>
                    `);

                    const marker = new mapboxgl.Marker({ element: el, anchor: 'bottom' })
                        .setLngLat(coords)
                        .setPopup(popup)
                        .addTo(map);

                    marker.getElement().addEventListener('click', () => marker.togglePopup());

                    turnMarkers.push(marker);
                }
            });
            currentInstructions.push(`You have arrived at your destination: ${name}`);

            map.fitBounds([userCoords, end], { padding: 80 });

            if (auth.currentUser) {
                database.ref('users/' + auth.currentUser.uid + '/active_route').set({
                    destination: name,
                    eta_mins: Math.floor(data.duration / 60),
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }

        function setMode(mode) {
            currentMode = mode;
            setActiveModeButtons();
            updateModeIcon();
            if (currentDestCoords) {
                getRoute(currentDestCoords, currentDestName);
            }
        }

        function setActiveModeButtons() {
            document.querySelectorAll('#route-info .mode-btn').forEach(btn => {
                btn.classList.toggle('bg-white/40', btn.dataset.mode === currentMode);
                btn.classList.toggle('bg-white/20', btn.dataset.mode !== currentMode);
            });
        }

        function updateModeIcon() {
            const iconMap = {
                'driving': 'fa-car',
                'driving-traffic': 'fa-bus',
                'cycling': 'fa-bicycle',
                'walking': 'fa-person-walking'
            };
            const iconEl = document.getElementById('mode-icon');
            if (iconEl) iconEl.className = `fa-solid ${iconMap[currentMode]} mr-1`;
        }

        function startVoiceNavigation() {
            if ('speechSynthesis' in window && currentInstructions.length > 0) {
                speechSynthesis.cancel();
                let index = 0;
                const speakNext = () => {
                    if (index < currentInstructions.length) {
                        const utterance = new SpeechSynthesisUtterance(currentInstructions[index]);
                        utterance.lang = 'en-US';
                        utterance.rate = 0.9;
                        utterance.onend = () => {
                            index++;
                            speakNext();
                        };
                        speechSynthesis.speak(utterance);
                    }
                };
                speakNext();
            }
        }

        function handleSignIn(provider) {
            let prov;
            if (provider === 'google') prov = new firebase.auth.GoogleAuthProvider();
            else if (provider === 'github') prov = new firebase.auth.GithubAuthProvider();
            auth.signInWithPopup(prov);
        }

        function handleEmailSignIn() {
            const email = document.getElementById('email-input').value.trim();
            const password = document.getElementById('password-input').value;
            if (!email || !password) {
                alert('Please enter both email and password');
                return;
            }
            auth.signInWithEmailAndPassword(email, password)
                .catch(err => {
                    if (err.code === 'auth/user-not-found') {
                        auth.createUserWithEmailAndPassword(email, password)
                            .catch(createErr => alert(createErr.message));
                    } else {
                        alert(err.message);
                    }
                });
        }

        function handleSignOut() { auth.signOut(); }

        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('app-view').classList.remove('hidden');
                document.getElementById('user-avatar').src = user.photoURL || '';
                document.getElementById('user-avatar').classList.remove('hidden');
                document.getElementById('guest-icon').classList.add('hidden');
            } else {
                document.getElementById('login-view').classList.remove('hidden');
                document.getElementById('app-view').classList.add('hidden');
            }
        });

        initMap();
    </script>
</body>
</html>
