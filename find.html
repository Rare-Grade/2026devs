<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bophelo Bot | Facility Finder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
 
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        :root { --medical-emerald: #10b981; }
        body { font-family: 'Inter', sans-serif; overflow: hidden; background-color: #e2e8f0; }
        #map { position: absolute; inset: 0; z-index: 0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
       
        /* Mobile Bottom Sheet Transitions */
        .sheet-transition { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
       
        /* Collapsed state for mobile: pushes down leaving only top ~85px visible */
        .sheet-collapsed { transform: translateY(calc(100% - 85px)); }
       
        @media (min-width: 768px) {
            .sheet-collapsed { transform: none; }
        }

        /* Search Bar Animations */
        .search-container {
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .search-container:focus-within {
            transform: scale(1.02);
            box-shadow: 0 10px 40px -10px rgba(16, 185, 129, 0.3);
        }
        .search-input {
            transition: all 0.3s ease;
        }
        .search-container:focus-within .search-input {
            background-color: #ffffff;
        }

        /* Autocomplete Dropdown */
        .autocomplete-dropdown {
            animation: slideDown 0.2s ease-out;
            transform-origin: top;
        }
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px) scaleY(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scaleY(1);
            }
        }

        /* Voice Pulse Animation */
        .voice-pulse {
            animation: voicePulse 1.5s ease-in-out infinite;
        }
        @keyframes voicePulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }

        /* Touch-friendly scroll area */
        .touch-scroll {
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: contain;
        }
    </style>
</head>
<body class="h-screen w-screen relative">
    <div id="map"></div>
    <div class="absolute top-4 right-4 md:right-8 z-20 flex items-center gap-3">
        <div class="bg-white/90 backdrop-blur-md px-4 py-2 rounded-full shadow-lg border border-slate-100 hidden md:block">
            <span id="location-status" class="text-[10px] font-bold text-emerald-600 tracking-wide uppercase">GPS Linked</span>
        </div>
        <button onclick="handleSignOut()" class="w-12 h-12 rounded-full bg-white shadow-lg border border-slate-200 overflow-hidden hover:scale-105 transition active:scale-95 flex items-center justify-center">
            <img id="user-avatar" src="" alt="Profile" class="w-full h-full object-cover hidden">
            <i id="guest-icon" class="fa-solid fa-user text-slate-400 text-lg"></i>
        </button>
    </div>
    <div id="location-modal" class="hidden absolute inset-0 z-50 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-6">
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm text-center shadow-2xl scale-100">
            <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa-solid fa-location-slash text-2xl"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-900 mb-2">Location Required</h3>
            <p class="text-slate-500 text-sm mb-6">Please enable location services to find medical facilities near you.</p>
            <button onclick="requestLocation()" class="w-full bg-emerald-600 text-white p-3 rounded-xl font-semibold hover:bg-emerald-700 transition">
                Enable Location
            </button>
        </div>
    </div>
    <div id="bottom-panel" class="absolute z-30 bg-white w-full bottom-0 rounded-t-[30px] shadow-2xl md:top-0 md:left-0 md:w-[420px] md:h-full md:rounded-none flex flex-col overflow-hidden max-h-[85vh] md:max-h-full sheet-transition">
       
        <div class="w-full flex justify-center pt-3 pb-1 md:hidden" onclick="expandBottomSheet()">
            <div class="w-12 h-1.5 bg-slate-200 rounded-full"></div>
        </div>
        <div id="login-view" class="p-8 flex flex-col h-full justify-center overflow-y-auto touch-scroll">
            <div class="mb-8 text-center md:text-left">
                <div class="w-12 h-12 bg-emerald-100 rounded-xl flex items-center justify-center text-emerald-600 mb-4 mx-auto md:mx-0">
                    <i class="fa-solid fa-location-crosshairs text-xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-900 mb-2">Bophelo Bot</h2>
                <p class="text-slate-500 text-sm">Real-time facility routing and medical assistance.</p>
            </div>
            <div class="space-y-3">
                <button onclick="handleSignIn('google')" class="w-full flex items-center justify-center gap-3 bg-white border border-slate-200 text-slate-700 p-4 rounded-2xl font-semibold hover:bg-slate-50 transition">
                    <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5"> Sign in with Google
                </button>
                <button onclick="handleSignIn('github')" class="w-full flex items-center justify-center gap-3 bg-white border border-slate-200 text-slate-700 p-4 rounded-2xl font-semibold hover:bg-slate-50 transition">
                    <i class="fa-brands fa-github text-xl"></i> Sign in with GitHub
                </button>
            </div>
            <div class="relative my-6">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-slate-200"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="bg-white px-4 text-slate-400">or</span>
                </div>
            </div>
            <div class="space-y-4">
                <input id="email-input" type="email" placeholder="Enter your email" required class="w-full bg-slate-50 p-4 rounded-2xl outline-none focus:ring-2 focus:ring-emerald-500/20 font-medium transition-all" onclick="expandBottomSheet()">
                <input id="password-input" type="password" placeholder="Enter your password" required class="w-full bg-slate-50 p-4 rounded-2xl outline-none focus:ring-2 focus:ring-emerald-500/20 font-medium transition-all" onclick="expandBottomSheet()">
                <button onclick="handleEmailSignIn()" class="w-full bg-emerald-600 text-white p-4 rounded-2xl font-semibold hover:bg-emerald-700 transition">
                    Continue with Email
                </button>
            </div>
            <p class="text-xs text-slate-500 text-center mt-4">New here? We'll create an account for you.</p>
        </div>
        <div id="app-view" class="flex flex-col h-full hidden">
            <div class="px-6 pt-2 pb-4 border-b border-slate-100 bg-white z-20 sticky top-0" onclick="expandBottomSheet()">
                <div class="relative search-container rounded-2xl">
                    <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 peer-focus:text-emerald-600 transition-colors z-10"></i>
                    <input id="facility-search" type="text" placeholder="Search (e.g. Pharmacy, ER)"
                        class="search-input w-full bg-slate-50 p-4 pl-12 pr-24 rounded-2xl outline-none focus:ring-2 focus:ring-emerald-500/20 font-medium transition-all peer"
                        oninput="handleSearchInput(this)"
                        onfocus="expandBottomSheet(); showSuggestions()"
                        onkeypress="if(event.key === 'Enter') searchAndRoute(this.value)">
                    
                    <!-- Voice Search Button -->
                    <button id="voice-search-btn" class="absolute right-10 top-1/2 -translate-y-1/2 text-slate-400 hover:text-emerald-600 transition z-10 p-2" onclick="toggleVoiceSearch()">
                        <i class="fa-solid fa-microphone text-lg"></i>
                    </button>
                    
                    <!-- Clear Button -->
                    <button id="clear-search-btn" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 hover:text-slate-700 hidden z-10" onclick="clearFacilitySearch()">
                        <i class="fa-solid fa-xmark text-lg"></i>
                    </button>
                </div>
                
                <!-- Autocomplete Suggestions -->
                <div id="autocomplete-dropdown" class="autocomplete-dropdown hidden absolute left-6 right-6 top-full mt-2 bg-white rounded-2xl shadow-2xl border border-slate-100 overflow-hidden z-30 max-h-64 overflow-y-auto">
                    <!-- Suggestions will be populated here -->
                </div>
            </div>
           
            <div class="flex-1 overflow-y-auto touch-scroll no-scrollbar p-6 space-y-4 bg-slate-50/50">
                <div id="route-info" class="hidden bg-emerald-600 text-white p-5 rounded-3xl shadow-lg mb-4">
                    <h4 class="text-xs font-bold uppercase opacity-80 mb-1">Active Destination</h4>
                    <p id="dest-name" class="font-bold text-lg leading-tight">Finding route...</p>
                    <div class="flex gap-4 mt-3 text-sm font-medium">
                        <span><i id="mode-icon" class="fa-solid fa-car mr-1"></i> <span id="route-dist">0 km</span></span>
                        <span><i class="fa-solid fa-clock mr-1"></i> <span id="route-time">0 min</span></span>
                    </div>
                    <div class="flex justify-center gap-4 mt-5">
                        <button data-mode="driving" onclick="setMode('driving')" class="mode-btn p-3 rounded-xl bg-white/40 hover:bg-white/50 transition text-2xl"><i class="fa-solid fa-car"></i></button>
                        <button data-mode="driving-traffic" onclick="setMode('driving-traffic')" class="mode-btn p-3 rounded-xl bg-white/20 hover:bg-white/30 transition text-2xl"><i class="fa-solid fa-bus"></i></button>
                        <button data-mode="cycling" onclick="setMode('cycling')" class="mode-btn p-3 rounded-xl bg-white/20 hover:bg-white/30 transition text-2xl"><i class="fa-solid fa-bicycle"></i></button>
                        <button data-mode="walking" onclick="setMode('walking')" class="mode-btn p-3 rounded-xl bg-white/20 hover:bg-white/30 transition text-2xl"><i class="fa-solid fa-person-walking"></i></button>
                        <button onclick="startVoiceNavigation()" class="p-3 rounded-xl bg-white/20 hover:bg-white/30 transition text-2xl"><i class="fa-solid fa-volume-high"></i></button>
                    </div>
                </div>
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Recommended</h3>
                <div onclick="searchAndRoute('Hospital')" class="bg-white p-4 rounded-3xl border border-slate-100 cursor-pointer hover:border-emerald-500 transition">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-red-50 text-red-500 rounded-xl flex items-center justify-center"><i class="fa-solid fa-truck-medical"></i></div>
                        <div><h4 class="font-bold">Nearest Emergency ER</h4><p class="text-xs text-slate-500">Auto-route to highest rated</p></div>
                    </div>
                </div>
                <div onclick="searchAndRoute('Pharmacy')" class="bg-white p-4 rounded-3xl border border-slate-100 cursor-pointer hover:border-emerald-500 transition">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-emerald-50 text-emerald-500 rounded-xl flex items-center justify-center"><i class="fa-solid fa-pills"></i></div>
                        <div><h4 class="font-bold">24/7 Pharmacy</h4><p class="text-xs text-slate-500">Find medication nearby</p></div>
                    </div>
                </div>
                <div onclick="searchAndRoute('Clinic')" class="bg-white p-4 rounded-3xl border border-slate-100 cursor-pointer hover:border-emerald-500 transition">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-blue-50 text-blue-500 rounded-xl flex items-center justify-center"><i class="fa-solid fa-hospital"></i></div>
                        <div><h4 class="font-bold">General Clinic</h4><p class="text-xs text-slate-500">Primary care facilities</p></div>
                    </div>
                </div>
                <div onclick="searchAndRoute('General Practitioner')" class="bg-white p-4 rounded-3xl border border-slate-100 cursor-pointer hover:border-emerald-500 transition">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-indigo-50 text-indigo-500 rounded-xl flex items-center justify-center"><i class="fa-solid fa-stethoscope"></i></div>
                        <div><h4 class="font-bold">Family Doctor / GP</h4><p class="text-xs text-slate-500">General practitioners</p></div>
                    </div>
                </div>
                <div onclick="searchAndRoute('Dentist')" class="bg-white p-4 rounded-3xl border border-slate-100 cursor-pointer hover:border-emerald-500 transition">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-purple-50 text-purple-500 rounded-xl flex items-center justify-center"><i class="fa-solid fa-tooth"></i></div>
                        <div><h4 class="font-bold">Dentist</h4><p class="text-xs text-slate-500">Dental care services</p></div>
                    </div>
                </div>
                <div onclick="searchAndRoute('Optometrist')" class="bg-white p-4 rounded-3xl border border-slate-100 cursor-pointer hover:border-emerald-500 transition">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-pink-50 text-pink-500 rounded-xl flex items-center justify-center"><i class="fa-solid fa-eye"></i></div>
                        <div><h4 class="font-bold">Optometrist</h4><p class="text-xs text-slate-500">Eye care & vision testing</p></div>
                    </div>
                </div>
                <div onclick="searchAndRoute('Physiotherapy')" class="bg-white p-4 rounded-3xl border border-slate-100 cursor-pointer hover:border-emerald-500 transition">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-teal-50 text-teal-500 rounded-xl flex items-center justify-center"><i class="fa-solid fa-person-walking-arrow-loop-left"></i></div>
                        <div><h4 class="font-bold">Physiotherapy</h4><p class="text-xs text-slate-500">Rehabilitation services</p></div>
                    </div>
                </div>
                <div onclick="searchAndRoute('Laboratory')" class="bg-white p-4 rounded-3xl border border-slate-100 cursor-pointer hover:border-emerald-500 transition">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-orange-50 text-orange-500 rounded-xl flex items-center justify-center"><i class="fa-solid fa-vial"></i></div>
                        <div><h4 class="font-bold">Medical Laboratory</h4><p class="text-xs text-slate-500">Testing & diagnostics</p></div>
                    </div>
                </div>
                <div onclick="searchAndRoute('Psychologist')" class="bg-white p-4 rounded-3xl border border-slate-100 cursor-pointer hover:border-emerald-500 transition">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-gray-50 text-gray-500 rounded-xl flex items-center justify-center"><i class="fa-solid fa-brain"></i></div>
                        <div><h4 class="font-bold">Psychologist</h4><p class="text-xs text-slate-500">Mental health support</p></div>
                    </div>
                </div>
                <div onclick="searchAndRoute('Pediatrician')" class="bg-white p-4 rounded-3xl border border-slate-100 cursor-pointer hover:border-emerald-500 transition">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-yellow-50 text-yellow-600 rounded-xl flex items-center justify-center"><i class="fa-solid fa-baby"></i></div>
                        <div><h4 class="font-bold">Pediatrician</h4><p class="text-xs text-slate-500">Child health specialists</p></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script>
        mapboxgl.accessToken = 'pk.eyJ1Ijoia2F0bGVnb3BoYXNoYSIsImEiOiJjbTlpOTdzbmYwMGNsMmpzYWJtZzN4d3pqIn0.Zt-aSMEoahrV3zkiVVHbOw';
     
        const firebaseConfig = {
            apiKey: "AIzaSyAxBT0oESoL62oz_x_Z8cMtdENWZPx4tMI",
            authDomain: "pinotp-d7ef5.firebaseapp.com",
            databaseURL: "https://pinotp-d7ef5-default-rtdb.firebaseio.com",
            projectId: "pinotp-d7ef5",
            storageBucket: "pinotp-d7ef5.firebasestorage.app",
            messagingSenderId: "708458917827",
            appId: "1:708458917827:web:375de278577df0adcf9776"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        let map, userCoords = [28.2293, -25.7479];
        let currentMode = 'driving';
        let currentDestCoords = null;
        let currentDestName = null;
        let destMarker = null;
        let turnMarkers = [];
        let currentInstructions = [];
        let watchId = null;
        let recognition = null;
        let isListening = false;

        // Initialize speech recognition
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            
            recognition.onstart = function() {
                isListening = true;
                document.getElementById('voice-search-btn').classList.add('voice-pulse', 'text-emerald-600');
                document.getElementById('facility-search').placeholder = 'Listening...';
            };
            
            recognition.onend = function() {
                isListening = false;
                document.getElementById('voice-search-btn').classList.remove('voice-pulse', 'text-emerald-600');
                document.getElementById('facility-search').placeholder = 'Search (e.g. Pharmacy, ER)';
            };
            
            recognition.onresult = function(event) {
                const transcript = Array.from(event.results)
                    .map(result => result[0])
                    .map(result => result.transcript)
                    .join('');
                
                document.getElementById('facility-search').value = transcript;
                toggleClearButton(document.getElementById('facility-search'));
                
                if (event.results[0].isFinal) {
                    setTimeout(() => {
                        searchAndRoute(transcript);
                    }, 500);
                }
            };
            
            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                isListening = false;
                document.getElementById('voice-search-btn').classList.remove('voice-pulse', 'text-emerald-600');
            };
        }

        function toggleVoiceSearch() {
            if (!recognition) {
                alert('Voice search is not supported in your browser');
                return;
            }
            
            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        }

        // Autocomplete suggestions
        const medicalSuggestions = [
            'Hospital', 'Emergency Room', 'Pharmacy', 'Clinic', 'General Practitioner',
            'Family Doctor', 'Dentist', 'Optometrist', 'Eye Doctor', 'Physiotherapy',
            'Physical Therapy', 'Medical Laboratory', 'Blood Test', 'Psychologist',
            'Mental Health', 'Pediatrician', 'Children Doctor', 'Cardiologist',
            'Dermatologist', 'Orthopedic', 'Gynecologist', 'Urgent Care', 'Walk-in Clinic'
        ];

        function handleSearchInput(input) {
            toggleClearButton(input);
            showSuggestions();
        }

        function showSuggestions() {
            const input = document.getElementById('facility-search');
            const dropdown = document.getElementById('autocomplete-dropdown');
            const value = input.value.toLowerCase();
            
            if (value.length < 1) {
                dropdown.classList.add('hidden');
                return;
            }
            
            const filtered = medicalSuggestions.filter(s => 
                s.toLowerCase().includes(value) && s.toLowerCase() !== value
            ).slice(0, 5);
            
            if (filtered.length === 0) {
                dropdown.classList.add('hidden');
                return;
            }
            
            dropdown.innerHTML = filtered.map(suggestion => `
                <div onclick="selectSuggestion('${suggestion}')" 
                     class="px-4 py-3 hover:bg-slate-50 cursor-pointer flex items-center gap-3 transition-colors border-b border-slate-50 last:border-0">
                    <i class="fa-solid fa-magnifying-glass text-slate-400 text-sm"></i>
                    <span class="text-slate-700 font-medium">${suggestion}</span>
                </div>
            `).join('');
            
            dropdown.classList.remove('hidden');
        }

        function selectSuggestion(value) {
            document.getElementById('facility-search').value = value;
            document.getElementById('autocomplete-dropdown').classList.add('hidden');
            toggleClearButton(document.getElementById('facility-search'));
            searchAndRoute(value);
        }

        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            const searchContainer = document.querySelector('.search-container');
            const dropdown = document.getElementById('autocomplete-dropdown');
            if (!searchContainer.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        });

        function initMap() {
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/navigation-night-v1',
                center: userCoords,
                zoom: 14
            });
            map.on('load', () => {
                map.addSource('mapbox-traffic', {
                    type: 'vector',
                    url: 'mapbox://mapbox.mapbox-traffic-v1'
                });
                map.addLayer({
                    id: 'traffic',
                    type: 'line',
                    source: 'mapbox-traffic',
                    'source-layer': 'traffic',
                    layout: { 'line-join': 'round', 'line-cap': 'round' },
                    paint: {
                        'line-width': 4,
                        'line-color': [
                            'match',
                            ['get', 'congestion'],
                            'low', '#00b300',
                            'moderate', '#ffaa00',
                            'heavy', '#ff6600',
                            'severe', '#ff0000',
                            '#aaaaaa'
                        ]
                    }
                }, 'road-label');
                updateWeatherOverlay();
                setInterval(updateWeatherOverlay, 600000);
            });
            map.on('dragstart', collapseBottomSheet);
            map.on('click', collapseBottomSheet);
            map.on('touchstart', collapseBottomSheet);
            startLocationTracking();
        }

        function collapseBottomSheet() {
            if (window.innerWidth < 768) {
                document.getElementById('bottom-panel').classList.add('sheet-collapsed');
            }
        }
        function expandBottomSheet() {
            document.getElementById('bottom-panel').classList.remove('sheet-collapsed');
        }
        function requestLocation() {
            document.getElementById('location-modal').classList.add('hidden');
            startLocationTracking();
        }

        const updateWeatherOverlay = async () => {
            try {
                const resp = await fetch('https://api.rainviewer.com/public/weather-maps.json');
                const data = await resp.json();
                let ts = data.generated;
                if (data.radar.past && data.radar.past.length > 0) {
                    ts = data.radar.past[data.radar.past.length - 1].time;
                }
                const tileUrl = `${data.host}/v2/radar/${ts}/256/{z}/{x}/{y}/2/1_1.png`;
                if (map.getSource('radar')) {
                    map.getSource('radar').setTiles([tileUrl]);
                } else {
                    map.addSource('radar', {
                        type: 'raster',
                        tiles: [tileUrl],
                        tileSize: 256,
                        attribution: '© RainViewer'
                    });
                    map.addLayer({
                        id: 'radar-layer',
                        type: 'raster',
                        source: 'radar',
                        paint: { 'raster-opacity': 0.45 }
                    });
                }
            } catch (err) {
                console.error('Weather overlay update failed:', err);
            }
        };

        function createUserMarker(coords) {
            const markerEl = document.createElement('div');
            markerEl.innerHTML = `
                <div class="relative">
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-12 h-12 bg-emerald-400 rounded-full opacity-75 animate-ping"></div>
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-12 h-12 bg-emerald-400 rounded-full opacity-40"></div>
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-10 h-10 bg-emerald-600 rounded-full shadow-2xl flex items-center justify-center">
                        <i class="fa-solid fa-person text-white text-2xl"></i>
                    </div>
                </div>
            `;
            window.userMarker = new mapboxgl.Marker({
                element: markerEl,
                anchor: 'center'
            }).setLngLat(coords).addTo(map);
        }

        function startLocationTracking() {
            if ('geolocation' in navigator) {
                if (watchId !== null) {
                    navigator.geolocation.clearWatch(watchId);
                }
                watchId = navigator.geolocation.watchPosition(
                    (pos) => {
                        document.getElementById('location-modal').classList.add('hidden');
                        const newCoords = [pos.coords.longitude, pos.coords.latitude];
                        userCoords = newCoords;
                        if (window.userMarker) {
                            window.userMarker.setLngLat(newCoords);
                        } else {
                            createUserMarker(newCoords);
                        }
                        if (!currentDestCoords) {
                            map.setCenter(newCoords);
                        }
                    },
                    (err) => {
                        console.error('Geolocation error:', err);
                        document.getElementById('location-modal').classList.remove('hidden');
                    },
                    { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 }
                );
            } else {
                document.getElementById('location-modal').classList.remove('hidden');
            }
        }

        function toggleClearButton(input) {
            const btn = document.getElementById('clear-search-btn');
            const voiceBtn = document.getElementById('voice-search-btn');
            if (input.value.length > 0) {
                btn.classList.remove('hidden');
                voiceBtn.classList.add('hidden');
            } else {
                btn.classList.add('hidden');
                voiceBtn.classList.remove('hidden');
            }
        }

        function clearFacilitySearch() {
            const input = document.getElementById('facility-search');
            input.value = '';
            toggleClearButton(input);
            document.getElementById('autocomplete-dropdown').classList.add('hidden');
            input.focus();
        }

        async function searchAndRoute(query) {
            expandBottomSheet();
            document.getElementById('autocomplete-dropdown').classList.add('hidden');
            const searchUrl = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?proximity=${userCoords[0]},${userCoords[1]}&access_token=${mapboxgl.accessToken}`;
            const res = await fetch(searchUrl);
            const data = await res.json();
         
            if (data.features.length > 0) {
                const target = data.features[0];
                const destCoords = target.center;
                currentDestCoords = destCoords;
                currentDestName = target.text;

                if (destMarker) destMarker.remove();

                const destEl = document.createElement('div');
                destEl.innerHTML = `
                    <div class="relative">
                        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-12 h-12 bg-red-400 rounded-full opacity-75 animate-ping"></div>
                        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-12 h-12 bg-red-400 rounded-full opacity-40"></div>
                        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-10 h-10 bg-red-600 rounded-full shadow-2xl flex items-center justify-center">
                            <i class="fa-solid fa-location-dot text-white text-3xl"></i>
                        </div>
                    </div>
                `;
                destMarker = new mapboxgl.Marker({
                    element: destEl,
                    anchor: 'center'
                }).setLngLat(destCoords).addTo(map);

                destMarker.setPopup(new mapboxgl.Popup({
                    offset: 25,
                    closeButton: true,
                    closeOnClick: false
                }).setHTML(`
                    <div class="bg-white p-4 rounded-lg shadow-lg max-w-xs font-medium">
                        <strong class="text-lg block mb-1">${target.text}</strong>
                        <span class="text-sm text-slate-600">${target.place_name || 'No address available'}</span>
                    </div>
                `));

                destMarker.getElement().addEventListener('click', () => destMarker.togglePopup());

                document.getElementById('dest-name').innerText = target.text;
                document.getElementById('route-info').classList.remove('hidden');
                setActiveModeButtons();
                updateModeIcon();
                getRoute(destCoords, target.text, target.place_name);
               
                setTimeout(collapseBottomSheet, 1500);
            }
        }

        async function getRoute(end, name, fullName) {
            if (map.getLayer('route')) map.removeLayer('route');
            if (map.getSource('route')) map.removeSource('route');
            turnMarkers.forEach(m => m.remove());
            turnMarkers = [];
            currentInstructions = [];

            const profile = currentMode;
            const query = await fetch(`https://api.mapbox.com/directions/v5/mapbox/${profile}/${userCoords[0]},${userCoords[1]};${end[0]},${end[1]}?steps=true&geometries=geojson&access_token=${mapboxgl.accessToken}`);
            const json = await query.json();
            if (!json.routes || json.routes.length === 0) return;
            const data = json.routes[0];
         
            document.getElementById('route-dist').innerText = (data.distance / 1000).toFixed(1) + ' km';
            document.getElementById('route-time').innerText = Math.floor(data.duration / 60) + ' min';
            updateModeIcon();

            const geojson = { type: 'Feature', geometry: data.geometry };
            map.addSource('route', { type: 'geojson', data: geojson });
            map.addLayer({
                id: 'route',
                type: 'line',
                source: 'route',
                paint: { 'line-color': '#ffffff', 'line-width': 10, 'line-opacity': 0.8 }
            });

            currentInstructions = [`Starting navigation to ${name}. Distance ${(data.distance / 1000).toFixed(1)} km, estimated time ${Math.floor(data.duration / 60)} minutes.`];

            data.legs[0].steps.forEach((step, index) => {
                if (step.maneuver && step.maneuver.location) {
                    const coords = step.maneuver.location.coordinates;
                    const instruction = step.maneuver.instruction || 'Continue straight';
                    const stepDist = step.distance ? (step.distance / 1000).toFixed(1) + ' km' : 'short distance';
                    const stepTime = step.duration ? '~' + Math.round(step.duration / 60) + ' min' : '';

                    currentInstructions.push(instruction);

                    const el = document.createElement('div');
                    el.className = 'bg-white text-emerald-600 w-9 h-9 rounded-full flex items-center justify-center font-bold text-sm shadow-lg border-2 border-emerald-600 cursor-pointer';
                    el.innerText = index + 1;

                    const popup = new mapboxgl.Popup({
                        offset: 35,
                        closeButton: true,
                        closeOnClick: false
                    }).setHTML(`
                        <div class="bg-white p-4 rounded-lg shadow-lg max-w-xs">
                            <strong class="block mb-1">Step ${index + 1}</strong>
                            <p class="font-medium">${instruction}</p>
                            ${stepDist || stepTime ? `<p class="text-sm text-slate-600 mt-2">${stepDist} • ${stepTime}</p>` : ''}
                        </div>
                    `);

                    const marker = new mapboxgl.Marker({ element: el, anchor: 'bottom' })
                        .setLngLat(coords)
                        .setPopup(popup)
                        .addTo(map);

                    marker.getElement().addEventListener('click', () => marker.togglePopup());
                    turnMarkers.push(marker);
                }
            });

            currentInstructions.push(`You have arrived at your destination: ${name}`);

            map.fitBounds([userCoords, end], { padding: 80 });

            if (auth.currentUser) {
                database.ref('users/' + auth.currentUser.uid + '/active_route').set({
                    destination: name,
                    eta_mins: Math.floor(data.duration / 60),
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }

        function setMode(mode) {
            currentMode = mode;
            setActiveModeButtons();
            updateModeIcon();
            if (currentDestCoords) {
                getRoute(currentDestCoords, currentDestName);
            }
        }

        function setActiveModeButtons() {
            document.querySelectorAll('#route-info .mode-btn').forEach(btn => {
                btn.classList.toggle('bg-white/40', btn.dataset.mode === currentMode);
                btn.classList.toggle('bg-white/20', btn.dataset.mode !== currentMode);
            });
        }

        function updateModeIcon() {
            const iconMap = {
                'driving': 'fa-car',
                'driving-traffic': 'fa-bus',
                'cycling': 'fa-bicycle',
                'walking': 'fa-person-walking'
            };
            const iconEl = document.getElementById('mode-icon');
            if (iconEl) iconEl.className = `fa-solid ${iconMap[currentMode]} mr-1`;
        }

        function startVoiceNavigation() {
            if ('speechSynthesis' in window && currentInstructions.length > 0) {
                speechSynthesis.cancel();
                let index = 0;
                const speakNext = () => {
                    if (index < currentInstructions.length) {
                        const utterance = new SpeechSynthesisUtterance(currentInstructions[index]);
                        utterance.lang = 'en-US';
                        utterance.rate = 0.9;
                        utterance.onend = () => {
                            index++;
                            speakNext();
                        };
                        speechSynthesis.speak(utterance);
                    }
                };
                speakNext();
            }
        }

        function handleSignIn(provider) {
            let prov;
            if (provider === 'google') prov = new firebase.auth.GoogleAuthProvider();
            else if (provider === 'github') prov = new firebase.auth.GithubAuthProvider();
            auth.signInWithPopup(prov);
        }

        function handleEmailSignIn() {
            const email = document.getElementById('email-input').value.trim();
            const password = document.getElementById('password-input').value;
            if (!email || !password) {
                alert('Please enter both email and password');
                return;
            }
            auth.signInWithEmailAndPassword(email, password)
                .catch(err => {
                    if (err.code === 'auth/user-not-found') {
                        auth.createUserWithEmailAndPassword(email, password)
                            .catch(createErr => alert(createErr.message));
                    } else {
                        alert(err.message);
                    }
                });
        }

        function handleSignOut() { auth.signOut(); }

        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('app-view').classList.remove('hidden');
                document.getElementById('user-avatar').src = user.photoURL || '';
                document.getElementById('user-avatar').classList.remove('hidden');
                document.getElementById('guest-icon').classList.add('hidden');
            } else {
                document.getElementById('login-view').classList.remove('hidden');
                document.getElementById('app-view').classList.add('hidden');
            }
        });

        initMap();
    </script>
</body>
</html>
